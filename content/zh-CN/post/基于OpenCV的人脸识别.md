---
title: "基于OpenCV的人脸识别"
date: "2019-01-12 20:22:44"
draft: false
categories:
 - "学校笔记整理"
tags:
 - "学校学习笔记"
series: ["学校学习笔记"]
toc: true
---

#  基于OpenCV的人脸识别                             

## 1.背景

### 	1.1 人脸识别

随着数字信号和模拟信号处理理论和计算机的发展，通过CMOS摄像头获取的模拟信号转化为数字信号，然后使用计算机实现对视觉信息的处理，这就提出了一个新的理念“怎样通过计算机来进行生物的检测”，随着科学技术的不断创新及发展，这个理念被实现了，生物特征检测技术中人脸的自动检测占有重要的地位，人脸检测技术与其他生物检测方法相比，人脸检测具有算法简单、设计更直接、友好和方便等特点，因而人脸自动检测问题的研究不仅具有重要的应用价值，而且具有重要的理论意义。人脸检测主要用在公共安全领域、智能家居、金融管理、物业管理、以及网络安全和考勤等方面。由于数字信息比模拟信息更易于存储和处理，因此，在视频监控领域采用计算机对视频信息进行采集、存储、分析得到许多人的青睐。 基于OPENCV的人脸检测和检测在计算机模式检测与视觉领域中占有重要的地位，人脸检测和检测利用分析比较人脸特征来进行身份鉴定的生物技术，通过级联分类检测器来进行人脸图片的训练，然后从摄像头上采集图片在库中进行比对，如果比对结果在预设的阀值之内，则表示检测成功。 
       怎样使计算机能够像人一样能够分析各种视觉信息，使用一种编制的方式来计算获得的视觉数据。使机器智能化，通过机器来模拟人类所拥有的能力，像人类一样通过眼睛来观察和获得视觉信息，并使用大脑来处理视觉所获得的信息。近年来各个领域使用了计算机视觉技术来解决该问题，该技术在视觉模式中具有重要的应用价值。人脸检测技术除了在智能视频监控系统中具有非常重要的应用外，在视频会议、人机交互、门禁控制、家庭娱乐以及信息安全等场合也有着重要的应用。

### 1.2实现方式

人脸检测技术股由于受到一些光线，环境的影响会造成检测的精度不高， 现在大多数都集中研究在正面人脸图像的检测上，但由于人脸面部表情、拍照角度或拍照光照等条件的变化下，得到的人脸照片中的特征不同，因此使用数据库中存储的样本的有限个角度拍摄的照片，去检测任意角度的照片，使检测范围得到很大的限制。
       为了解决以上出现的问题，现在人们提出了使用几何特征检测法来进行人脸的检测，选取的特征点必须具有代表性，能代表一个人的面部特征，唯一标识该个体，选取眼角点、鼻翼点、嘴角点等标识眼、耳、口、鼻及脸部轮廓的特征点。
采集的图片进行人脸检测通过以下步骤，先对需要检测的目标进行特征的提取，利用这些特征数据建立目标检测模型，然后将需要检测的图像与目标模型进行匹配，如果匹配成功则使用矩形来进行标记。
        光线补偿技术：因为在不同的环境中，光线对图像会产生干扰，图像就会变得或明或暗，我们就要对其进行调整，所以采用光线补偿来处理图像的亮度变化。 高斯平滑技术：在视频图像的采集过程中，由于外界条件的干扰，则采集的图片中会出现一些噪音，这就会使图像在进行转化、检测时发生的数据的遗失和损坏等，这些会对以后图片的训练产生干扰，所以将图片进行平滑处理来消除噪声的干扰。灰度变换技术：进行灰度转换时，我们要保证图像信息保持不变。我们在使用灰度转换时，先对图像数据进行统计，经过比较后得出一个合适的灰度值，然后对图像进行灰度变换。灰度均衡技术：经过灰度转换后，就要进行灰度均衡化操作，最后通过灰度分布来对图像进行灰度均衡。对比度增强技术：通过对某个图片的点进行定位，然后将其周围的像素值进行统计，再通过聚集技术将相邻的像素值拉开，使他们之间的差距拉大。
        OpenCV(Open Source Computer Vision Library)是一个是由英特尔公司发起并参与开发，以BSD许可证授权发行，可以在商业和研究领域中免费使用的跨平台计算机视觉库，OpenCV可用于开发实时的图像处理、计算机视觉以及模式识别程序。该程序库也可以使用英特尔公司的IPP进行加速处理。OpenCV可以运行在Linux、Windows、Android和Mac OS操作系统上。它轻量级而且高效——由一系列 C 函数和少量 C++ 类构成，同时提供了Python、Ruby、MATLAB等语言的接口，实现了图像处理和计算机视觉方面的很多通用算法。
        OpenCV用C++语言编写，它的主要接口也是C++语言，但是依然保留了大量的C语言接口。该库也有大量的Python、Java and MATLAB/OCTAVE（版本2.5）的接口。这些语言的API接口函数可以通过在线文档获得。如今也提供对于C#、Ch、Ruby,GO的支持。

## 2.工程实现

人脸识别是对已知人脸进行分类的过程。就像人看到人的脸时，就能识别他们是自己的家人、朋友或名人。有很多技术能够让计算机学习人脸，人脸识别的主要包括人脸检测、人脸预处理、收集和学习人脸、人脸识别四个步骤。

### 2.1 人脸检测

​	人脸检测是在图像中定位人脸区域的过程，这一步不关心人是谁，只是关心是不是人脸。

#### (1)读入图片

当配置好OpenCV库与Qt Creater开发环境后，调用OpenCV的库函数，调用cv::Mat image = cv::imread("1.jpg", cv::IMREAD_COLOR);打开图片，其中:IMREAD_COLOR为图片的通道描述，将打开的图片以RGB三通道的方式读取。其读取效果如下图。

![image-20220405230832996](/blogMaties/image-20220405230832996.png)

<center>图1 读入图片</center>

#### (2)灰度图像转换

​	人脸检测只适用于灰度图像，因此，应当转换彩色照片为灰度图像。使用cv::cvtColor(image, image_gray,cv::COLOR_BGR2GRAY);完成了灰度图像的转换。其中cvtColor函数可以实现RGB转换为HSV，HIS等颜色空间转换。其中image为输入的彩色图像，image_gray为输出的图像，COLOR_BGR2GRAY为彩色图像转换为灰色的属性。

####  (3)直方图均衡化

使用直方图均衡化，改善图像的对比图和亮度。使用cv::equalizeHist(image_gray, image_gray);函数进行直方图均衡化提升亮度和对比度。

![image-20220405231750816](/blogMaties/image-20220405231750816.png)

<center>图2 灰色图像</center>

![image-20220405231826277](/blogMaties/image-20220405231826277.png)

<center>               图3 直方图均衡化图像</center>

#### (4)分类器

​	OpenCV提供了对象检测器，通过LBP的特征检测器可以能通过训练从大的图像集中找到人脸，这些图像存在于XML文件中。一般情况下图像分类检测器通常至少使用1000个独特的人脸图像和10000个非人脸图像作为训练才能产生训练数据。OpenCV自带训练好的额LBP检测器供用户使用，只要加载不同级联的分类器的XML文件给对象检测器就可以检测正面人脸、轮廓的面孔，眼睛或鼻子。为了便于后面的人脸图像预处理。在这里检测出人脸和人眼。加载OpenCV给定的XML数据集，使用矩形窗标记出人脸和眼睛。其中人脸的数据集在其中haarcascade_frontalface_alt.xml文件中，由于个人佩戴眼镜，所以选择眼睛所在的数据集为haarcascade_eye_tree_eyeglasses.xml，打开数据集会发现大量训练好的数据。检测时是灰色图像检测，我最终在彩色图像上显示效果图如下所示。

![image-20220405231918041](/blogMaties/image-20220405231918041.png)

<center>图4  人脸检测</center>>

### 2.2人脸预处理

人脸预处理是调整人脸图像，使其看起来更加清除，且相似于其他人脸的过程。
人眼检测对于人脸的预处理非常有用，对于人脸而言，面部表情、光照条件、摄像机的属性、与相机的距离等都会发生变化，但是人眼是水平的，并且对称分布在人脸上，两只眼睛在人脸的位置和大小是相当标准的。当人脸检测器将别的对象当成人脸时，可以通过眼部检测丢弃这种误判。人脸检测完成后，截取出人脸所在的区域，为了保持人脸在水平线上，将检测到眼睛中心位置的x为准线，将图像进行旋转和平移操作，以使眼睛能被对齐，保证训练图像和测试图像在同一位置。由于人脸识别的特征都在虹膜、鼻翼、嘴角等面像五官轮廓的大小、位置、距离等属性。对于截取的人脸图像在经过删除额头、下巴、耳朵和北京的操作，对于图像中含有噪声的影响，使用双边滤波器进行平滑操作减少噪声。最后使用椭圆掩码将图像中剩余的头发和人脸的背景去掉。
人脸检测中得到的人眼的中心计算亮眼的角度，得到两眼的距离。依照此进行平移旋转操作。一般情况下，人的左右脸光照强度不一样，将左右脸分别进行直方图均衡，再标准化人脸两侧的亮度和对比度，在进行直方图均衡的过程中会大幅度提高像素的噪声，所以设置滤波器进行光滑处理，滤除过多的像素噪声。虽然开始通过几何变化删除了大部分图像的背景、额头以及头发，但是还需要采用椭圆掩码删除一些拐角区域。这些区域可能来自于人脸的阴影，为了创建掩码，需要在白色图像上画一个椭圆，其内部为白色，外部为黑色。椭圆的水平方向上的半径等于人脸的宽度，在垂直方向上的半径小于人脸的高度，设为0.8。
⦁	为了避免背景的影响，将检测到的人脸单独成像。
⦁	检测出人脸中的人眼，并确定人眼的中心。
⦁	将两眼中心连线为标准旋转，得到水平图像，并截取人脸的额头、颈部等部位。
⦁	对图像进行平滑处理，滤除噪声。
⦁	画一个椭圆，再次截取图像，得到最终的特征脸。

![image-20220405232304772](/blogMaties/image-20220405232304772.png)

​                                                                          图5.1                                          图5.2                                            图5.3

![image-20220405232517889](/blogMaties/image-20220405232517889.png)

​                                                                     图5.4                                                 图5.5                                              图5.6
图5.1 截取人脸为单独图像
图5.2 检测人眼
图5.3 旋转至水平，截取人脸
图5.4 平滑滤波
图5.5 掩膜图像
图5.6 经过预处理的彩色图像

### 2.3训练数据及人脸识别 

学习和搜集人脸是收集许多被预处理的人脸，然后学习如何识别它们。然后所搜集的人脸中查找出哪一个人脸与给定图片的人脸最相似。第九章老师讲过人工神经网络模式识别，我这里用到的是特征脸识别。特征脸识别也叫做PCA，与K-L变化相似。
KL展开是随机过程的理论，将随机过程描述成无穷个正交函数的线性结合。其重要性在于，得到的结果拥有最小均方差。不同于傅里叶级数展开（系数为实数&展开基函数由正余弦函数组成），KL展开的系数是随机变量，且展开基函数由随机过程决定。实际上，这里的正交基函数是由随机过程的协方差函数确定的。可以认为，KL展开是根据随机过程产生最佳基函数。完成KL展开，就需要求出正交基函数。由于线性映射等各种性质，可知未知量满足均匀弗雷德霍姆积分方程，即可通过解方程求出基函数。
        PCA即主成分分析技术，又称主分量分析。主成分分析也称主分量分析，旨在利用降维的思想，把多指标转化为少数几个综合指标。在PCA中，数据从原来的坐标系转换到新的坐标系，由数据本身决定。转换坐标系时，以方差最大的方向作为坐标轴方向，因为数据的最大方差给出了数据的最重要的信息。第一个新坐标轴选择的是原始数据中方差最大的方法，第二个新坐标轴选择的是与第一个新坐标轴正交且方差次大的方向。重复该过程，重复次数为原始数据的特征维数。通过这种方式获得的新的坐标系，我们发现，大部分方差都包含在前面几个坐标轴中，后面的坐标轴所含的方差几乎为0,。于是，我们可以忽略余下的坐标轴，只保留前面的几个含有绝不部分方差的坐标轴。事实上，这样也就相当于只保留包含绝大部分方差的维度特征，而忽略包含方差几乎为0的特征维度，也就实现了对数据特征的降维处理。
         总的来说，K-L是一种对于连续或离散的随机过程都可进行的变换，PCA则是KLT处理离散情况的算法；定义上KLT比PCA广泛，而实际上PCA比KLT实用。用一组备注好的人脸图像训练特征脸，其中部分备注好的图像如图所示，
                                                            ![image-20220405233735473](/blogMaties/image-20220405233735473.png)

​                                                            图6.1 备注好的人脸原图                  图6.2 导入训练的图片
​         在OpenCV中images.push_back(src_1); labels.push_back(1);导入样本并设置标签，save("CAD_faceClass.xml")最后讲数据保存为xml格式的文件。调用OpenCV的predict函数查询在原图像在数据库中属于何种标签，我用Debug打印出标签，即为识别的结果。

另外，在编写程序的过程中，一直是黑白、彩色，产生了实现图像黑白素描的想法，我查询OpenCV的库函数，结合上课第七章图像分割所学，实现黑白素描图像即为实现边缘点检测， 可以使用各种边缘滤波器实现功能。我们检测到不同亮度的边缘后，让边缘看上去更像素描，使用二值化阈值使边缘只有白色或者黑色，这也就实现了素描图像。在这里二值化门限选择也对描述的边缘检测效果有影响，试了几组参数后，选择相对而言看上去较为理想的情况如图7.2所示。
         ![image-20220405233418223](/blogMaties/image-20220405233418223.png)![image-20220405233433207](/blogMaties/image-20220405233433207-16492567013251.png)
                                              图7.1 原图                                                                    图7.2 边缘检测图

## 3.总结

在现实生活中，无论是去银行办理业务，还是做飞机安检前的识别，都含有人脸识别。再加上老师在课堂上讲K-L变换的时候举了人脸识别的例子。于是大作业想用硬件实现一个人脸识别系统。目前是在Linux下使用Qt与OpenCV库函数实现。由于时间和个人原因尚未嫁接到硬件电路。
OpenCV讲图像处理的操作封装在库函数中，加上课堂上学习的数字图像处理的知识，使用起来非常简单。随着人工智能的发展，人脸识别系统实现的方式种类也很多。根据其硬件所在的环境选择合适的算法。本系统旨在嫁接到嵌入式ARM芯片中，使用神经网络其实时性差，运算要求性能高。因此选用PCA算法作为人脸识别的算法。人脸识别的主要包括人脸检测、人脸预处理、收集和学习人脸、人脸识别四个步骤。基于OpenCV的人脸检测在计算机模式检测与视觉领域中占有重要的地位，人脸检测和检测利用分析比较人脸特征来进行身份鉴定的生物技术，通过级联分类检测器来进行人脸图片的训练，然后将图片在库中进行比对，如果比对结果在预设的阀值之内，则表示检测成功。将结果打印出来。
       通过本次编程，了解了OpenCV的用法，深入体会了数字图像处理的技术和应用场合，再加上上课所学的知识，使用C++语言、Qt框架，理论与实践相结合。最重要的是对于图像处理产生了兴趣，希望在以后的学习研究中，能和老师多交流，充分发挥上课学习的知识，有更大的收获。